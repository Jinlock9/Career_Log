# Task 2501-03
- Date: 2025.01.22

### Procedure
1. Find out why this "should have positive impact optimizarion" have a negtive impact on the kernel cycles. (this: Machine Code Sinking)
    - First identify which code block cause the difference. Narrow down the testcases, in this file, comment out the testcases but only leave the one you think is easy to investigate.
    - Modify `DLC_Custom_Kernel/syntests/syntests_main.cpp` -> `ninja syntests install`
    - add `--jumpdbg` after your command will print the branch info and the number of cycles the branch occurs. After you find the code blocks, go back to llvm to find out what happened to those code during that optimization

```sh
# after changing syntests_main.cpp
ninja syntests install

# Modify autotune_strategies.csv
rm -f CMakeCache.txt && cmake -G Ninja ../ && ninja install

./syntests/syntests -t isnan_bf16 --jumpdbg
```
- Note: 
    - `1092` is the start address of the main program, all the thing before `1092` is initialization
    - pay attention to reletive difference rather than absolute one
    - See `DLC_Custom_Kernel/build/dlc_src/isnan_bf16.dlcasm`
    - the instruction number in dlcasm file plus `1092` will be the `pc` you see in the debug info

- Worker.py
```py
#!/usr/bin/env python3

import re
import os
import subprocess
import sys

def parse_log_and_compute_gaps(file_path):
    jump_pattern = re.compile(r'\[XYS[01]\]jump from (\d+) \(\d+\) to (\d+) \(\d+\) at Cycle: (\d+)')
    jumps = {"XYS0": [], "XYS1": []}

    with open(file_path, 'r') as file:
        for line in file:
            match = jump_pattern.search(line)
            if match:
                label = "XYS0" if "[XYS0]" in line else "XYS1"
                start = int(match.group(1))
                end = int(match.group(2))
                cycle = int(match.group(3))
                jumps[label].append((start, end, cycle))

    for label in jumps:
        print(f"\n{label} Cycle Gaps:")
        for i in range(1, len(jumps[label])):
            prev_start, prev_end, prev_cycle = jumps[label][i - 1]
            curr_start, curr_end, curr_cycle = jumps[label][i]
            cycle_gap = curr_cycle - prev_cycle
            print(f"{label} [{prev_start}:{prev_end}] to [{curr_start}:{curr_end}] : {cycle_gap}")

def update_dlcasm_numbers(dlc_file_path):
    """Add 1092 to each number in front of the :{} in the DLCASM file."""
    try:
        with open(dlc_file_path, "r") as file:
            lines = file.readlines()

        updated_lines = []
        for line in lines:
            updated_line = line
            if ":{" in line:
                parts = line.split(":{")
                try:
                    number = int(parts[0].strip())
                    updated_number = number + 1092
                    updated_line = f"{updated_number}:{{" + "{".join(parts[1:])
                except ValueError:
                    pass
            updated_lines.append(updated_line)

        with open(dlc_file_path, "w") as file:
            file.writelines(updated_lines)

        print(f"Updated numbers in {dlc_file_path}.")
    except Exception as e:
        print(f"Failed to update numbers in {dlc_file_path}: {e}")

def run_script(option):
    if option[1] == '--off':
        log_file_path = "Results/result_off.txt"
        dlc_file_path = "Results/result_off.dlcasm"
    elif option[1] == '--on':
        log_file_path = "Results/result_on.txt"
        dlc_file_path = "Results/result_on.dlcasm"
    else:
        print("Invalid option. Use --off or --on.")
        sys.exit(1)

    if len(sys.argv) > 2:
        if option[2] == '--cmake':
            # Step 1: Remove CMakeCache.txt, configure, and build
            subprocess.run(["rm", "-f", "CMakeCache.txt"])
            subprocess.run(["cmake", "-G", "Ninja", "../"])
            subprocess.run(["ninja", "install"])

    # Step 2: Run syntests and save output
    with open(log_file_path, "w") as log_file:
        subprocess.run(["./syntests/syntests", "-t", "isnan_bf16", "--jumpdbg"], stdout=log_file)

    # Step 3: Copy the resulting DLCASM file
    subprocess.run(["cp", "dlc_src/isnan_bf16.dlcasm", dlc_file_path])

    # Step 4: Update numbers in the DLCASM file
    update_dlcasm_numbers(dlc_file_path)

    # Step 5: Calculate and print cycle gaps
    parse_log_and_compute_gaps(log_file_path)

    print(f"Processed {option}: Log saved to {log_file_path}, DLCASM saved to {dlc_file_path}.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 Worker.py --off or python3 Worker.py --on")
        sys.exit(1)

    run_script(sys.argv)

```
- run `python3 Worker.py --[on|off] [--cmake]